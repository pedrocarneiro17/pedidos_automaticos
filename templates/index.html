<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automação de Pedidos Mercos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { 
            background-color: #f8f9fa; 
        }
        .container { 
            max-width: 800px; 
            margin-top: 3rem;
            margin-bottom: 3rem;
        }
        .section {
            background-color: #ffffff;
            padding: 2rem;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        .section-title {
            font-weight: 300;
            color: #343a40;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .log-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            max-height: 300px;
            overflow-y: scroll;
            padding: 1rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .order-item, .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }
        .order-item:last-child, .product-item:last-child {
            border-bottom: none;
        }
        
        /* Estilos para o Autocomplete de Clientes */
        .autocomplete-container { 
            position: relative; 
        }
        .autocomplete-results { 
            position: absolute; 
            border: 1px solid #dee2e6; 
            border-top: none; 
            z-index: 99; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background-color: white; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-results div { 
            padding: 10px; 
            cursor: pointer; 
        }
        .autocomplete-results div:hover { 
            background-color: #e9ecef; 
        }
        .autocomplete-results .cnpj { 
            font-size: 0.8em; 
            color: #6c757d; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="text-center flex-grow-1">
                <h1 class="display-5">Automação de Pedidos</h1>
                <p class="lead text-muted">Preencha os dados, adicione os pedidos à fila e dispare o robô.</p>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">Sair</a>
        </div>

        <div class="section">
            <h4 class="section-title">1. Credenciais Mercos</h4>
            <form id="credentialsForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email:</label>
                    <input type="email" class="form-control" id="email" name="email" value="{{ email }}" required>
                </div>
                <div class="mb-3">
                    <label for="senha" class="form-label">Senha:</label>
                    <input type="password" class="form-control" id="senha" name="senha" value="{{ senha }}" required>
                </div>
                <button type="submit" class="btn btn-dark">Salvar Credenciais</button>
                <div id="credentialsStatus" class="mt-3"></div>
            </form>
        </div>

        <div class="section">
            <h4 class="section-title">2. Montar Novo Pedido</h4>
            <form id="addOrderForm">
                <div class="row">
                    <div class="col-md-12 mb-3 autocomplete-container">
                        <label for="client_search" class="form-label">Cliente (digite nome ou CNPJ):</label>
                        <input type="text" class="form-control" id="client_search" placeholder="Comece a digitar..." required autocomplete="off">
                        <input type="hidden" id="cnpj_cliente" name="cnpj_cliente"> 
                        <div class="autocomplete-results" id="client_results" style="display: none;"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome_representada" class="form-label">Representada:</label>
                        <input type="text" class="form-control" id="nome_representada" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="condicao_pagamento" class="form-label">Cond. Pagamento:</label>
                        <input type="text" class="form-control" id="condicao_pagamento" required>
                    </div>
                </div>

                <h6 class="mt-3">Produtos do Pedido:</h6>
                <div id="productsContainer" class="mb-3 border rounded p-2">
                    <p class="text-muted m-2" id="noProductsMessage">Nenhum produto adicionado.</p>
                </div>

                <div class="row g-2 align-items-end">
                    <div class="col">
                        <input type="text" class="form-control" id="product_code" placeholder="Digite ou selecione o código" list="product-list" autocomplete="off">
                        <datalist id="product-list"></datalist>
                    </div>
                    <div class="col"><input type="number" step="0.01" class="form-control" id="product_quantity" placeholder="Quantidade"></div>
                    <div class="col"><input type="text" class="form-control" id="product_price" placeholder="Preço (ex: 12,50)"></div>
                    <div class="col-auto"><button type="button" class="btn btn-outline-secondary w-100" id="addProductBtn">Adicionar</button></div>
                </div>
                <hr class="my-4">
                <button type="submit" class="btn btn-dark w-100">Adicionar Pedido à Fila</button>
            </form>
        </div>
        
        <div class="section">
            <h4 class="section-title">3. Fila de Pedidos (<span id="ordersCount">0</span>)</h4>
            <div id="accumulatedOrdersContainer" class="mb-4">
                <p id="noAccumulatedOrdersMessage" class="text-muted">Nenhum pedido na fila.</p>
            </div>
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary btn-lg" id="startAutomationBtn">
                    <span id="automationSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                    Disparar Automação
                </button>
            </div>
        </div>
        
        <div class="section">
            <h4 class="section-title">Log da Automação</h4>
            <div id="automationLog" class="log-box">
                <p class="text-muted">Aguardando início da automação...</p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentProductsForOrder = [];
            let accumulatedOrders = {{ current_orders | tojson }};

            // --- CARREGAMENTO INICIAL DE DADOS ---
            updateAccumulatedOrdersUI();
            
            $.get('/get_products', function(products) {
                let productOptions = '';
                products.forEach(function(prod) {
                    productOptions += `<option value="${prod.code}">${prod.name}</option>`;
                });
                $('#product-list').html(productOptions);
            });

            // --- LÓGICA DO AUTOCOMPLETE DE CLIENTES ---
            $('#client_search').on('keyup', function() {
                let query = $(this).val();
                if (query.length < 3) {
                    $('#client_results').hide();
                    return;
                }
                $.get('/search_clients', { query: query }, function(clients) {
                    let resultsHtml = '';
                    clients.forEach(function(client) {
                        resultsHtml += `<div class="client-option" data-name="${client.name}" data-cnpj="${client.cnpj}">
                                            <div>${client.name}</div>
                                            <div class="cnpj">${client.cnpj}</div>
                                        </div>`;
                    });
                    $('#client_results').html(resultsHtml).show();
                });
            });

            $(document).on('click', '.client-option', function() {
                let name = $(this).data('name');
                let cnpj = $(this).data('cnpj');
                
                $('#client_search').val(name);
                $('#cnpj_cliente').val(cnpj);
                $('#client_results').hide();
            });

            $(document).on('click', function(e) {
                if (!$(e.target).closest('.autocomplete-container').length) {
                    $('#client_results').hide();
                }
            });

            // --- LÓGICA DOS FORMULÁRIOS E BOTÕES ---
            $('#credentialsForm').submit(function(e) { 
                e.preventDefault(); 
                $.post('/', { 
                    action: 'set_credentials', 
                    email: $('#email').val(), 
                    senha: $('#senha').val() 
                }, function(response) { 
                    $('#credentialsStatus').html('<div class="alert alert-success mt-2 py-2">' + response.message + '</div>'); 
                }).fail(function(response) { 
                    $('#credentialsStatus').html('<div class="alert alert-danger mt-2 py-2">Erro: ' + response.responseJSON.message + '</div>'); 
                }); 
            });

            $('#addProductBtn').click(function() { 
                let code = $('#product_code').val().trim(); 
                let quantity = $('#product_quantity').val().trim(); 
                let price = $('#product_price').val().trim(); 
                if (code && quantity && price) { 
                    currentProductsForOrder.push({ codigo: code, quantidade: quantity, preco: price }); 
                    updateProductsForOrderUI(); 
                    $('#product_code, #product_quantity, #product_price').val(''); 
                } else { 
                    alert('Por favor, preencha todos os campos do produto.'); 
                } 
            });

            $(document).on('click', '.remove-product-btn', function() { 
                let index = $(this).data('index'); 
                currentProductsForOrder.splice(index, 1); 
                updateProductsForOrderUI(); 
            });

            $('#addOrderForm').submit(function(e) { 
                e.preventDefault(); 
                if (currentProductsForOrder.length === 0) { 
                    alert('Adicione pelo menos um produto ao pedido.'); 
                    return; 
                } 
                if (!$('#cnpj_cliente').val()) { 
                    alert('Por favor, selecione um cliente da lista.'); 
                    return; 
                } 
                $.post('/', { 
                    action: 'add_pedido', 
                    cnpj_cliente: $('#cnpj_cliente').val(), 
                    nome_representada: $('#nome_representada').val(), 
                    condicao_pagamento: $('#condicao_pagamento').val(), 
                    produtos_do_pedido: JSON.stringify(currentProductsForOrder) 
                }, function(response) { 
                    alert(response.message); 
                    accumulatedOrders = response.current_orders; 
                    updateAccumulatedOrdersUI(); 
                    $('#addOrderForm')[0].reset(); 
                    $('#client_search').val(''); 
                    currentProductsForOrder = []; 
                    updateProductsForOrderUI(); 
                }).fail(function(response) { 
                    alert('Erro ao adicionar pedido: ' + response.responseJSON.message); 
                }); 
            });
            
            $(document).on('click', '.remove-accumulated-order-btn', function() { 
                if (!confirm('Tem certeza?')) return; 
                let index = $(this).data('index'); 
                $.post('/', { action: 'remove_pedido', index: index }, function(response) { 
                    accumulatedOrders = response.current_orders; 
                    updateAccumulatedOrdersUI(); 
                }).fail(function(response) { 
                    alert('Erro: ' + response.responseJSON.message); 
                }); 
            });

            $('#startAutomationBtn').click(function() { 
                if (accumulatedOrders.length === 0) { 
                    alert('Nenhum pedido na fila!'); 
                    return; 
                } 
                $(this).prop('disabled', true); 
                $('#automationSpinner').removeClass('d-none'); 
                $('#automationLog').html('<p class="text-info">Iniciando automação...</p>'); 
                $.post('/', { action: 'start_automation' }, function(response) { 
                    if (response.status === 'success') { 
                        monitorAutomationStatus(); 
                    } else { 
                        alert('Erro: ' + response.message); 
                        $('#startAutomationBtn').prop('disabled', false); 
                        $('#automationSpinner').addClass('d-none'); 
                    } 
                }).fail(function(response) { 
                    alert('Erro: ' + response.responseJSON.message); 
                    $('#startAutomationBtn').prop('disabled', false); 
                    $('#automationSpinner').addClass('d-none'); 
                }); 
            });

            // --- FUNÇÕES DE ATUALIZAÇÃO DA INTERFACE ---
            function updateProductsForOrderUI() { 
                let html = ''; 
                if (currentProductsForOrder.length === 0) { 
                    html = '<p class="text-muted m-2" id="noProductsMessage">Nenhum produto adicionado.</p>'; 
                } else { 
                    currentProductsForOrder.forEach(function(product, index) { 
                        html += `<div class="product-item"><span><strong>${product.codigo}</strong> (Qtd: ${product.quantidade}, Preço: ${product.preco})</span><button type="button" class="btn btn-sm btn-outline-danger remove-product-btn" data-index="${index}">X</button></div>`; 
                    }); 
                } 
                $('#productsContainer').html(html); 
            }

            function updateAccumulatedOrdersUI() { 
                let html = ''; 
                if (accumulatedOrders.length === 0) { 
                    html = '<p id="noAccumulatedOrdersMessage" class="text-muted">Nenhum pedido na fila.</p>'; 
                } else { 
                    accumulatedOrders.forEach(function(order, index) { 
                        let productList = ''; 
                        order.produtos.forEach(prod => { 
                            productList += `<li><small>${prod.codigo} (Qtd: ${prod.quantidade}, Preço: ${prod.preco})</small></li>`; 
                        }); 
                        html += `<div class="order-item"><div><strong>Cliente: ${order.cnpj_cliente}</strong><ul class="list-unstyled mb-0">${productList}</ul></div><button type="button" class="btn btn-sm btn-outline-danger remove-accumulated-order-btn" data-index="${index}">Remover</button></div>`; 
                    }); 
                } 
                $('#accumulatedOrdersContainer').html(html); 
                $('#ordersCount').text(accumulatedOrders.length); 
            }

            function monitorAutomationStatus() { 
                let interval = setInterval(function() { 
                    $.get('/?action=get_status', function(response) { 
                        $('#automationLog').html(response.log.join('\n')); 
                        $('#automationLog').scrollTop($('#automationLog')[0].scrollHeight); 
                        accumulatedOrders = response.current_orders; 
                        updateAccumulatedOrdersUI(); 
                        if (!response.running) { 
                            clearInterval(interval); 
                            $('#startAutomationBtn').prop('disabled', false); 
                            $('#automationSpinner').addClass('d-none'); 
                            let logText = response.log.join('\n'); 
                            if (logText.includes("TODOS OS PEDIDOS FORAM PROCESSADOS")) { 
                                $('#automationLog').append('<p class="text-success mt-2"><strong>Automação concluída com sucesso!</strong></p>'); 
                            } else if (logText.includes("Ocorreu um erro durante a automação")) { 
                                $('#automationLog').append('<p class="text-danger mt-2"><strong>Automação finalizada com erros!</strong></p>'); 
                            } else { 
                                $('#automationLog').append('<p class="text-warning mt-2"><strong>Automação finalizada.</strong></p>'); 
                            } 
                        } 
                    }); 
                }, 2000); 
            }
        });
    </script>
</body>
</html>